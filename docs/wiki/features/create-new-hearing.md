# Create New Hearing <!-- omit in toc -->

- [Background](#background)
- [Plan](#plan)
  - [First Hearing for a Case](#first-hearing-for-a-case)
  - [Subsequent Hearings for a Case](#subsequent-hearings-for-a-case)
  - [Sending emails](#sending-emails)
- [End-to-end Test](#end-to-end-test)
- [Future Enhancements/Recommendation](#future-enhancementsrecommendation)
- [Outstanding questions/To Dos/Next Steps](#outstanding-questionsto-dosnext-steps)

## Background

As a Moderator, or Scheduling Coordinator, I can create an invitation for a new online hearing(s). Access to creating a
new hearing is provided to all Members and Owners (not Guests) of the Teams channel that have added this application.

## Plan

### First Hearing for a Case

For the first hearing of a case (as in the first time we see a certain case number), we need to create all of the
associated database entries and send out events to the Event Grid. The Call Management Bot then picks up those events and
creates the online meetings and event. After the meetings and event are created, the database is updated with the call
and event information.

<!-- generated by mermaid compile action - START -->

![~mermaid diagram 1~](../../images/docs_wiki_features_create-new-hearing-md-1.png)

<details>
  <summary>Mermaid markup</summary>

```mermaid
sequenceDiagram
    UI ->>+ API: POST /courts/{courtId}/courtrooms/{courtroomId}/hearings

    API ->> CosmosDB: INSERT case
    par For all Case Rooms
        API -) EventGrid: CaseRoomCreated /case/{caseId}
    and Create hearing once
        API ->> CosmosDB: INSERT hearing
        API -) EventGrid: HearingCreated /hearing/{hearingId}
        API -) EventGrid: HearingScheduled /hearing/{hearingId}
    and For all Participants
        API ->> CosmosDB: INSERT hearingParticipants
    and For all "Default" Hearing Rooms
        API ->> CosmosDB: INSERT hearingRoom
        API ->> EventGrid: HearingRoomCreated /hearingroom/{hearingRoomId}
    and For all "Default" Solo Rooms
        API ->> CosmosDB: INSERT soloRoom
        API ->> EventGrid: SoloRoomCreated /soloroom/{soloRoomId}
        Note over EventGrid: This is currently not handled
    end

    API -->>- UI: 201 CREATED

    par For all "Default" Hearing Rooms
        EventGrid -)+ GraphAdapter: HearingRoomCreated /hearingroom/{hearingRoomId}
        GraphAdapter ->> MS Graph: POST /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: HearingRoomOnlineMeetingCreated /hearingroom/{hearingRoomId}

        EventGrid -)+ API: HearingRoomOnlineMeetingCreated /hearingroom/{hearingRoomId}
        API ->> CosmosDB: UPDATE hearingRoom
        API -)- EventGrid: HearingRoomOnlineMeetingInfoAvailable /hearingRoom/{hearingRoomId}
    and For each room in the case
        EventGrid -)+ GraphAdapter: CaseRoomCreated /case/{caseId}
        GraphAdapter ->> MS Graph: POST /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: CaseRoomOnlineMeetingCreated /case/{caseId}

        EventGrid -)+ API: CaseRoomOnlineMeetingCreated /case/{caseId}
        API ->> CosmosDB: UPDATE case
        API ->>- EventGrid: CaseRoomOnlineMeetingInfoAvailable /case/{caseId}
    and For each Hearing
        EventGrid -)+ GraphAdapter: HearingScheduled /hearing/{hearingId}
        GraphAdapter ->> MS Graph: POST /users/{userId}/events
        GraphAdapter -)- EventGrid: HearingCalendarEventCreated /hearing/{hearingId}
        EventGrid -)+ API: HearingCalendarEventCreated /hearing/{hearingId}
        API ->> CosmosDB: UPDATE case
        API -)- EventGrid: HearingEventInfoAvailableEvent /hearing/{hearingId}
    end
```

</details>
<!-- generated by mermaid compile action - END -->

### Subsequent Hearings for a Case

For all subsequent hearing of a case where the case number already exists in our database, the same meeting from the
previous case needs to be reused so that history such as chat is maintained. To enable that, the same case meetings
from the first hearing will be reused, just extended to encompass the total duration of all hearing dates. Then all
of the hearing meetings are created the same as before, database entries created, and events to the Event Grid.

The Call Management Bot then picks up those events and creates the online meetings. After the meetings are created,
the database is updated with the call information.

<!-- generated by mermaid compile action - START -->

![~mermaid diagram 2~](../../images/docs_wiki_features_create-new-hearing-md-2.png)

<details>
  <summary>Mermaid markup</summary>

```mermaid
sequenceDiagram
    UI ->>+ API: POST /courts/{courtId}/courtrooms/{courtroomId}/hearings

    API ->> CosmosDB: UPSERT case
    par For each case room
        Note over API: Only if the overall case length changed
        API --) EventGrid: CaseRoomOnlineMeetingDurationChanged /case/{caseId}
        Note over API: Generally this would just be if the court or case name changed
        API --) EventGrid: CaseRoomSubjectChanged /case/{caseId}

    and Create hearing once
        API ->> CosmosDB: INSERT hearing
        API -) EventGrid: HearingCreated /hearing/{hearingId}
        API -) EventGrid: HearingScheduled /hearing/{hearingId}
    and For all Participants
        API ->> CosmosDB: INSERT hearingParticipants
    and For all "Default" Hearing Rooms
        API ->> CosmosDB: INSERT hearingRoom
        API ->> EventGrid: HearingRoomCreated /hearingroom/{hearingRoomId}
    and For all "Default" Solo Rooms
        API ->> CosmosDB: INSERT soloRoom
        API ->> EventGrid: SoloRoomCreated /soloroom/{soloRoomId}
        Note over EventGrid: This is currently not handled
    end

    API -->>- UI: 201 CREATED

    par For all "Default" Hearing Rooms
        EventGrid -)+ GraphAdapter: HearingRoomCreated /hearingroom/{hearingRoomId}
        GraphAdapter ->> MS Graph: POST /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: HearingRoomOnlineMeetingCreated /hearingroom/{hearingRoomId}

        EventGrid -)+ API: HearingRoomOnlineMeetingCreated /hearingroom/{hearingRoomId}
        API ->> CosmosDB: UPDATE hearingRoom
        API -)- EventGrid: HearingRoomOnlineMeetingInfoAvailable /hearingRoom/{hearingRoomId}
    and For each Hearing
        EventGrid -)+ GraphAdapter: HearingScheduled /hearing/{hearingId}
        GraphAdapter ->> MS Graph: POST /users/{userId}/events
        GraphAdapter -)- EventGrid: HearingCalendarEventCreated /hearing/{hearingId}
        EventGrid -)+ API: HearingCalendarEventCreated /hearing/{hearingId}
        API ->> CosmosDB: UPDATE case
        API -)- EventGrid: HearingEventInfoAvailableEvent /hearing/{hearingId}
    end

    alt If subject changed for the case ... for each case room
    Note over API: Generally this would just be if the court or case name changed
        EventGrid -)+ GraphAdapter: CaseRoomSubjectChanged  /case/{caseId}
        GraphAdapter ->> MS Graph: PUT /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: CaseRoomOnlineMeetingChanged
    end
```

</details>
<!-- generated by mermaid compile action - END -->

### Sending emails

Sending emails responds to many of the events from the previous flows. Depending on the flag set at the organisation level:

1. Email with calendar invite sent to court staff only with a link to the reception room.
   or
2. Email sent to all participants with a link to the reception room.

The case and all other hearing rooms do not get emails generated for them.

## End-to-end Test

The following is an end-to-end testing matrix that will be used to validate the scenario.

| Test Case                                                                               | First case | Second Case                   |
| --------------------------------------------------------------------------------------- | ---------- | ----------------------------- |
| Supporting - Get Terminology Sets                                                       | Yes        |                               |
| Supporting - Get Terminology Set                                                        | Yes        |                               |
| Supporting - Get Presiding Judges                                                       | Yes        |                               |
| Database correctly updated with new entities - New Case and Hearing                     | Yes        |                               |
| Database correctly updated with new entities - Existing Case and Hearing                | Yes        |                               |
| Get Created Hearing Details match database                                              | Yes        |                               |
| New hearings appear on calendar (after refresh)                                         | Yes        |                               |
| Online Meeting are in Graph and sent to the event grid                                  | Yes        |                               |
| All Default Online Meetings for Hearing rooms created and call info updated in database | Yes        |                               |
| All Online Meetings for Case created and call info updated in database                  | Yes        | Multiple meetings future epic |
| Case Meeting updated with CaseDurationChanged in the database                           | Yes        |                               |
| CaseDurationChanged updated the length of the online meeting in Graph                   | Yes        |                               |
| Event for Hearing created and event and meeting info updated in database                | Yes        |                               |
| Emails sent to court staff with reception room                                          | Yes        |                               |
| Emails sent to participants with reception room                                         | Yes        |                               |

## Future Enhancements/Recommendation

<!--
Section Owner: Product Owner and Developer
-->

## Outstanding questions/To Dos/Next Steps

1. See current epic bug list for outstanding bugs
