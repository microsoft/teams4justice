# Edit a Hearing <!-- omit in toc -->

- [Background](#background)
- [Research](#research)
  - [Limitations](#limitations)
    - [Courtroom context](#courtroom-context)
    - [Associating to a different case](#associating-to-a-different-case)
- [Plan](#plan)
  - [Edit a Scheduled Hearing](#edit-a-scheduled-hearing)
- [End-to-end Test](#end-to-end-test)
- [Outstanding questions/To Dos/Next Steps](#outstanding-questionsto-dosnext-steps)
  - [Out of Scope for EditHearing](#out-of-scope-for-edithearing)
    - [CaseRoomOnlineMeetingDurationChanged](#caseroomonlinemeetingdurationchanged)
    - [HearingParticipantsChanged](#hearingparticipantschanged)
    - [HearingRescheduled](#hearingrescheduled)

## Background

As a Moderator, or Scheduling Coordinator, I can edit an invitation for an existing scheduled hearing.

## Research

### Limitations

#### Courtroom context

Currently the application is installed at a courtroom context. As we only authenticate and then use the teams channels
to determine authorisation, the user must only operate in the context of that court / courtroom combination.

For the end user this means they cannot alter which court or courtroom an existing hearing belongs to.

The workaround for this is to cancel the hearing and create a new one in the appropriate court room.

#### Associating to a different case

A hearing can be 1 of many parts of an overall case. The user isn't provided a separate screen to manage case so it is
part of the create hearing screen.

If the user discovers the case number they entered is incorrect the complexities around how this is seprated can be
quite involved depending on whether there are multiple hearings, if the it's a new case number etc.

For simplicity to the user, the case number will NOT be able to be edited once a hearing is created.

To fix this type of error the user would Cancel the hearing and Create a new hearing with the correct case number.

## Plan

### Edit a Scheduled Hearing

Prerequisite: only hearings that are of status "Scheduled" can be edited. Prerequisite: only hearings that have not
"stared" ie the start date time of the hearing must be in the future can be edited.

When the user edits the hearing information the updated information is saved to the database. If the user changes
information pertinent to the event email, this is raised to the event grid and the Call Management Bot will issue an updated
invite.

Changes relevant to items such as the bot ie dates will be raised separately in the epics and features they are required.

<!-- generated by mermaid compile action - START -->

![~mermaid diagram 1~](../../images/docs_wiki_features_edit-hearing-md-1.png)

<details>
  <summary>Mermaid markup</summary>

```mermaid
sequenceDiagram
Note over UI: User chooses to edit an existing hearing
    UI ->>+ API: GET /courts/{courtId}/courtrooms/{courtroomId}/hearings/{hearingId}
    API ->> Cosmos DB: RETRIEVE hearing

    Cosmos DB ->> API: hearing
    API ->>- UI: hearing

    Note over UI: User continues to fill in form for editing a hearing
    UI ->>+ API: PUT /courts/{courtId}/courtrooms/{courtroomId}/hearings/{hearingId}
    API -->> Cosmos DB: Update hearing
    API -->> Cosmos DB: For each new hearing participants Create Hearing Participant
    API -->> Cosmos DB: For each removed hearing participants Deactivate Hearing Participant
    API -->> Cosmos DB: Update case

    alt If email message changed
        API ->> Blob Storage: CREATE /emails/{hearingId}
    end

    alt If case name, start datetime, end datetime, email participants, email message changed
        API ->> EventGrid: HearingEdited
           participant GraphAdapter as Call Management Bot<br />hearing-edited Function
    EventGrid -)+ GraphAdapter: HearingEdited
    GraphAdapter ->> Blob Storage: READ /emails/{hearingId}
    Blob Storage -->> GraphAdapter: email body
    GraphAdapter ->> MS Graph: PUT /events
    GraphAdapter -)- EventGrid: HearingEventInfoChanged
    end

    alt If start datetime or end datetime changed
        API ->> EventGrid: HearingRescheduled
                participant CallManagementBot as Call Management Bot
    EventGrid -)+ CallManagementBot: HearingRescheduled
    end

    alt If subject changed for the case ... for each hearing room
    Note over API: Generally this would just be if the case name changed
        API ->> EventGrid: HearingRoomOnlineMeetingSubjectChanged
        EventGrid -)+ GraphAdapter: HearingRoomOnlineMeetingSubjectChanged  /hearingroom/{hearingRoomId}
        GraphAdapter ->> MS Graph: PUT /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: HearingRoomOnlineMeetingChanged
    end

    alt If subject changed for the case ... for each case room
    Note over API: Generally this would just be if the case name changed
        API ->> EventGrid: CaseRoomSubjectChanged
        EventGrid -)+ GraphAdapter: CaseRoomSubjectChanged  /case/{caseId}
        GraphAdapter ->> MS Graph: PUT /users/{userId}/onlineMeetings
        GraphAdapter -)- EventGrid: CaseRoomOnlineMeetingChanged
    end

    alt If start datetime or end datetime changed for the case ... for each case room
    Note over API: Not needed for Edit -> This event and flow has been created already. Bot/private rooms might want this raised in their feature
        API ->> EventGrid: CaseRoomOnlineMeetingDurationChanged
    end

    alt If participants list changed
    Note over API: Contains a list of added and removed participants. Any change to an existing participant is considered an add + remove.
        API ->> EventGrid: HearingParticipantsChanged
    end
```

</details>
<!-- generated by mermaid compile action - END -->

## End-to-end Test

| Test Case                                                                                           | First case | Second Case |
| --------------------------------------------------------------------------------------------------- | ---------- | ----------- |
| Error cases not saved - hearing started                                                             |            |             |
| Error cases not saved - hearing cancelled                                                           |            |             |
| Error cases not saved - court/courtroom doesn't match existing record                               |            |             |
| Database correctly updated Hearing - case name, start/end, terminolgy, timezone, message            |            |             |
| Database correctly updated HearingParticipants Added                                                |            |             |
| Database correctly updated HearingParticipants Removed                                              |            |             |
| Generate a new email Body                                                                           |            |             |
| HearingEdited event raised                                                                          |            |             |
| Event with updated participants sent                                                                |            |             |
| Event with updated dates sent                                                                       |            |             |
| Event with updated subject sent                                                                     |            |             |
| Event with updated body sent                                                                        |            |             |
| Event is not sent if no relevant information updated ie external participants, terminolgy, timezone |            |             |

## Outstanding questions/To Dos/Next Steps

### Out of Scope for EditHearing

#### CaseRoomOnlineMeetingDurationChanged

This event indicates the overaching start date and time for the case has changed. This flow was created for Create
Hearing. If other stories need this data then then they can consume this event as part of the relevant feature work.

#### HearingParticipantsChanged

This event would indicate the invited hearing participant list has changed. This event and flow has been created for
Edit Hearing. If other stories need this data then they can consume this event as part of the relevant feature work.

#### HearingRescheduled

This event would indicate the hearing start or end date and time has changed. This event and flow has been created for
Edit Hearing. If other stories need this data then they can consume this event as part of the relevant feature work.
