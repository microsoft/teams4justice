<!-- omit in toc -->

# Cancel a Hearing

- [Background](#background)
- [Research](#research)
- [Plan](#plan)
- [End-to-end Test](#end-to-end-test)
- [Release Notes](#release-notes)
- [Future Enhancements/Recommendation](#future-enhancementsrecommendation)
- [Outstanding questions/To Dos/Next Steps](#outstanding-questionsto-dosnext-steps)

## Background

As a Moderator, or Scheduling Coordinator, I can cancel an invitation for an existing scheduled hearing.

## Research

## Plan

### Cancel a Scheduled Hearing

Prerequisite: only hearings that are of status "Scheduled" can be cancelled.
Prerequisite: only hearings that have not "started" ie the start date time of the hearing must be in the future can be cancelled.

When the user cancels the hearing the updated status is saved to the database. A cancel event for the hearing and a
status change for each room is sent to the event grid.

<!-- generated by mermaid compile action - START -->

![~mermaid diagram 1~](../../images/docs_wiki_features_cancel-hearing-md-1.png)

<details>
  <summary>Mermaid markup</summary>

```mermaid
sequenceDiagram
Note over UI: User chooses to view an existing hearing
    UI ->>+ API: GET /courts/{courtId}/courtrooms/{courtroomId}/hearings/{hearingId}
    API -->> Cosmos DB: RETRIEVE hearing

    Cosmos DB ->> API: hearing
    API ->>- UI: hearing

    Note over UI: User chooses to cancel the hearing
    UI ->>+ API: DELETE /courts/{courtId}/courtrooms/{courtroomId}/hearings/{hearingId}
    par Once
      API ->> Cosmos DB: Update hearing - set to Cancelled
    and For each hearing room
      API ->> Cosmos DB: hearing room - set to Inactive
    and For each hearing participant
      API ->> Cosmos DB: hearing participants - set to Inactive
    end
    API ->> EventGrid: HearingCancelled
    EventGrid -)+ GraphAdapter: HearingCancelled
    GraphAdapter ->> MS Graph: DELETE /users/{userId}/events/{id}
    GraphAdapter ->>- EventGrid: HearingCalendarEventCancelled /hearing/hearingId
    loop For each hearing room
      API ->>- EventGrid: HearingRoomRemoved
      EventGrid -)+ GraphAdapter: HearingRoomRemoved
      GraphAdapter ->> MS Graph: DELETE /onlineMeeting
      GraphAdapter ->>- EventGrid: HearingRoomOnlineMeetingCancelled /hearingroom/hearingRoomId
    end
    loop For each solo room
      API ->> EventGrid: SoloRoomRemoved
      Note over EventGrid: This is not currently handled
    end
```

</details>
<!-- generated by mermaid compile action - END -->

## End-to-end Test

| Test Case                                                             | First case | Second Case |
| --------------------------------------------------------------------- | ---------- | ----------- |
| Error cases not saved - hearing started                               |            |             |
| Error cases not saved - hearing cancelled                             |            |             |
| Error cases not saved - court/courtroom doesn't match existing record |            |             |
| Database correctly updated Hearing - hearing status set to Cancelled  |            |             |
| Database correctly updated HearingParticipants Removed                |            |             |
| Database correctly updated HearingRooms Removed                       |            |             |
| Cancel email is sent                                                  |            |             |
| HearingCancelled event raised                                         |            |             |
| HearingRoomRemoved event raised for each hearing room                 |            |             |

## Outstanding questions/To Dos/Next Steps

### Out of Scope for CancelHearing

Cases are never removed/cancelled. The case level online meetings will be cleaned up by the bot when the case end date
passes or extended if a hearing is re-created.
